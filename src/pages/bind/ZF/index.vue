<script setup lang="ts">
import { Card, WButton, WModal } from "@/components";
import { helpText } from "@/constants/copywriting";
import { UserService } from "@/services";
import useHomeCardStore from "@/store/service/homecard";
import useUserStore from "@/store/service/user";
import { RequestError } from "@/utils";
import Taro from "@tarojs/taro";
import { ref } from "vue";

const userStore = useUserStore();
const homeCardStore = useHomeCardStore();
const helpContent = helpText.bind.zf;
const zfpass = ref("");
const isShowHelp = ref(false);

async function handleBind() {
  const regex = /^[a-zA-Z0-9!@#$%^&*()_+-=,.<>?;:'"{}[\]\\|`~]*$/;
  if (!regex.test(zfpass.value)) {
    Taro.showToast({
      title: "输入存在中文字符或其他非法字符,请重新输入！",
      icon: "none"
    });
    return;
  }
  Taro.showLoading({ title: "正在绑定", mask: true });
  try {
    await UserService.bindZF({ password: zfpass.value });
    Taro.showToast({ icon: "success", title: "绑定成功" });
    homeCardStore.add("lessons-table-quick-view");
    userStore.updateBindState("zf", true);
  } catch (e) {
    if (e instanceof RequestError) {
      await Taro.showToast({ icon: "none", title: e.message });
    }
  }
}

</script>

<template>
  <card class="bind-card">
    <template #header>
      <text>绑定账号</text>
      <view class="form-help-wrapper">
        <view
          class="form-help"
          @tap="() => isShowHelp = !isShowHelp"
        >
          <view class="iconfont icon-help" />
        </view>
      </view>
    </template>
    <text>正方教务系统</text>
    <view>
      <input
        v-model="zfpass"
        password
        :placeholder="!userStore.bindState.zf ? '请输入密码' : '*******'"
      >
    </view>
    <template #footer>
      <w-button block @tap="handleBind">
        确认绑定
      </w-button>
    </template>
  </card>
  <w-modal v-model:show="isShowHelp" :content="helpContent" />
</template>
